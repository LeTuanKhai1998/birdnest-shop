# Cursor Rules

## Instructions

- Record fixes for mistakes or corrections to avoid repetition in the `Lessons` section.
- Organize thoughts and plan steps before starting a task in the `Scratchpad` section.
- Clear old tasks if necessary.
- Use todo markers for progress tracking:
  - `[X]` Completed tasks
  - `[ ]` Pending tasks
- Update Scratchpad after completing subtasks.
- Reflect and plan after milestones for better task management.
- Always refer to Scratchpad before planning the next step.

## Lessons

## Scratchpad

### 1. Project Setup and Configuration []

- [X] Initialize Next.js 15 project with TypeScript
- [X] Set up project structure and folders
- [X] Configure ESLint and Prettier
- [X] Install and configure dependencies:
  - Shadcn UI components
  - Lucide icons
  - Zod for validation
  - Zustand for state management
  - Recharts for analytics
  - Resend for emails
  - Uploadthing for file uploads
  - Prisma ORM
  - PostgreSQL database
  - NextAuth.js beta for authentication
  - Stripe for payments

### 2. Database and Authentication []

- [X] Set up PostgreSQL database
- [X] Configure Prisma schema:
  - User model
  - Product model
  - Category model
  - Order model
  - Review model
  - Cart model
- [X] Implement NextAuth.js authentication:
  - Email/Password
  - OAuth providers (Google, GitHub)
  - JWT handling
  - Protected routes

### 3. Core Features - Customer Side [ ]

- [X] Home Layout:
  - Create `(home)` folder in the `app` directory  
  - Header with logo, search bar, and navigation (Home, Products, About, Contact)  
  - Footer with links (Purchase Policy, Delivery, Return & Exchange) and social media (Facebook, Zalo, Instagram)

- [X] Homepage:
  - Banner carousel (images of bird's nest, gift combos, promotions)  
  - Latest bird's nest products  
  - Premium bird's nest combos

- [X] Products Catalog:
  - Sidebar with categories and filters:  
    - Nest type: Refined Nest, Raw Nest, Feather-removed Nest  
    - Origin: Kien Giang  
    - Weight: 50g, 100g, 200g  
    - Price range  
  - Search results  
  - Product grid  
  - Pagination

- [X] Product pages:
  - Create product detail page layout  
  - Implement image gallery with thumbnails  
  - Add product information section:  
    - Product name, price, full description  
    - Stock status (in stock / out of stock)  
    - Add to cart button  
  - Reviews and ratings section:  
    - Display existing reviews  
    - Add review form for authenticated users  
    - Star rating component  
  - Related products section:  
    - Show products from the same category  
    - Product card carousel

- [X] Shopping cart:
  - Add/remove items  
  - Update quantities  
  - Cart persistence (via localStorage or Zustand)

- [X] Checkout process:
  - Shipping information (Full name, phone number, delivery address)  
  - Payment integration (Stripe — international, extendable to Momo/VNPAY later)  
  - Order confirmation page with order ID

- [X] User dashboard:
  - Order history (with status tracking)  
  - Profile management (personal info, password change)  
  - Saved addresses  
  - Wishlist (favorite products)


### 4. Admin Dashboard [ ]

- [X] Admin authentication and authorization (Implemented: /admin route, only accessible by isAdmin users, unauthorized users redirected)
- [X] Dashboard overview:
  - [X] Layout and Structure:
    - Create admin dashboard layout with sidebar navigation
    - Implement responsive grid for dashboard widgets
    - Add loading states and error boundaries
  - [X] Key Metrics Cards:
    - Total revenue widget with real data
    - Total orders widget with real data
    - Total customers widget with real data
    - Average order value widget with real data
  - [X] Sales Analytics:
    - [X] Revenue Chart:
      - Implement line chart using Recharts
      - Add daily/weekly/monthly/yearly filters
      - Show revenue trends over time
      - Add tooltip with detailed information
    - [X] Order Statistics:
      - Bar chart for order volume
      - Order status distribution
      - Peak ordering times
  - [X] Recent Orders Table:
    - [X] Implement data table with columns:
      - Order ID
      - Customer name
      - Order total
      - Status
      - Date
    - [X] Add sorting and filtering
    - [X] Quick actions (view, process, update status)
  - [X] Low Stock Alerts:
    - Products with stock below threshold
    - Quick restock actions
    - Stock level indicators
  - [X] Top Products:
    - Best-selling products list
    - Revenue by product
    - Stock status
  - [X] Customer Insights:
    - New vs returning customers
    - Customer acquisition chart
    - Top customers by revenue
  - [X] Real-time Updates:
    - Implement WebSocket connection
    - Live order notifications
    - Stock level updates
  - [X] Export and Reports:
    - CSV/PDF export functionality
    - Custom date range selection
    - Report generation
- [X] Product management:
  - CRUD operations
  - Bulk actions
  - Image upload (Uploadthing)
- [X] Order management:
  - Order processing
  - Status updates
  - Refund handling
- [X] User management:
  - Customer list
  - Admin privileges
  - User actions

### 5. Backend - NestJS API Server [X]

#### Setup and Architecture
- [X] Create new backend using NestJS (TypeScript):
  - [X] Initialize NestJS project in `/backend`
  - [X] Configure environment variables (`.env` file exists)
  - [X] Set up Prisma ORM with PostgreSQL database
  - [X] Implement JWT authentication and authorization
  - [X] Add complete API endpoints:
    - `/api/products` (GET, POST, PUT, DELETE) - ✅ Working
    - `/api/orders` (create, read, update status) - ✅ Working
    - `/api/users` (list customers, admin privileges) - ✅ Working
    - `/api/auth` (login, register, JWT) - ✅ Working
- [X] CORS enabled for frontend origin (localhost:3000, 3001)
- [X] Swagger documentation accessible at `/swagger`
- [X] Unit tests included (Jest configuration)
- [X] Startup commands via npm scripts (`npm run start:dev`)
- [X] Backend runs independently on port `8080` and frontend uses this base URL

#### Auth and Middleware
- [X] Implement JWT authentication and middleware
- [X] Middleware for:
  - [X] Auth guard (admin / customer) - JWT strategy implemented
  - [X] Logging - NestJS built-in logging
  - [X] CORS - Enabled for frontend origins
  - [ ] Rate limiting (can be added if needed)

#### Features to Implement (Mirror Frontend Needs)
- [X] Auth API:
  - [X] Sign in, Sign up - JWT authentication implemented
  - [X] OAuth login handler (Google/Github if needed) - Can be extended
  - [ ] Password reset (stub for now)
- [X] Products API:
  - [X] CRUD for admin - Complete implementation
  - [X] Public product listing, filter, search - Working with real data
- [X] Orders API:
  - [X] Create order - Implemented
  - [X] Update order status - Implemented
  - [X] Get order history (user & admin) - Implemented
- [ ] Cart API:
  - [ ] Add/remove/update cart items (frontend uses localStorage)
- [ ] Dashboard metrics API:
  - [ ] Total revenue, customers, AOV
  - [ ] Order stats (daily/weekly)
- [ ] Reviews API:
  - [ ] Add review (user)
  - [ ] List reviews per product

#### Migration Tasks
- [X] Identify mock or real API logic currently implemented in frontend `/app/api/**`
- [X] Migrate each handler into NestJS equivalents in `/backend/src/`
  - [X] Convert TypeScript/Next.js handlers to NestJS controllers/services
  - [X] Use DTOs and request validation via `class-validator`
- [X] Reuse Prisma schema models - Direct integration with Prisma client
- [X] Replace direct DB logic with services following clean architecture

#### Frontend Integration
- [X] Remove mock data in frontend (e.g., `/lib/mock`, hardcoded arrays)
- [X] Replace all API calls to use new backend endpoints
  - [X] Use `fetch` or `axios` pointing to `http://localhost:8080/api`
  - [X] API base URL configured in `frontend/lib/api.ts`
- [X] Ensure frontend dynamic pages (Products, Orders, User Management) render using real backend data
- [X] Update frontend loading states, error handling if necessary

#### Best Practices
- [X] Follow clean architecture principles
- [X] Handle errors via structured error types
- [X] Use DTOs / request binding with validation
- [X] Implement pagination, sorting, filtering
- [X] Write unit tests for services (Jest configuration ready)
- [X] Swagger / OpenAPI for documentation (via `@nestjs/swagger`)
- [X] Prepare npm scripts for dev tools (`npm run start:dev`, `npm run test`)


### 6. Code Quality, Refactor, Optimization [X]

- [X] Use **ESLint** and **Prettier** for linting and formatting.
- [X] Add `npm run lint` and `npm run format` in both frontend/backend.
- [X] Clean up:
  - [X] Unused imports / variables - Fixed in frontend components
  - [X] Duplicate logic - Removed unused variables and imports
  - [X] Dead code - Cleaned up unused functions and variables
- [X] Extract reusable logic to `services/` or `utils/`.
  - [X] Created proper TypeScript interfaces in `frontend/lib/types.ts`
  - [X] Created DTOs for backend validation in `backend/src/*/dto/`
- [X] Follow **Single Responsibility Principle** per function/module.
  - [X] Separated concerns in API service with proper types
  - [X] Created dedicated DTOs for validation
- [X] Optional: Add `husky` to auto-lint before commit.

---

### 7. Testing and Reliability [X]

- [X] Backend Unit Tests:
  - [X] Use **Jest** (NestJS mặc định hỗ trợ)
  - [X] Test service logic, controller endpoints
  - [X] Created comprehensive tests for ProductsService and OrdersService
  - [X] Fixed controller error handling (NotFoundException for missing products)
- [X] Frontend Unit Tests:
  - [X] Use **Jest + React Testing Library**
  - [X] Test components, forms, and auth logic
  - [X] Set up Jest configuration and testing environment
  - [X] Created utility function tests as examples
- [X] API Integration Tests:
  - [X] Use **Supertest** (backend) for endpoint testing
  - [X] Mock database (e.g. SQLite or in-memory)
  - [X] Test edge cases: auth failure, invalid input, DB errors
  - [X] Created e2e tests for products API endpoints
- [X] End-to-End Tests (Automation):
  - [X] Use **Supertest** for API endpoint testing
  - [X] Simulate real user flows (product listing, filtering, search)
  - [X] Add scripts like `npm run test:e2e`
  - [X] All backend tests passing (20 unit tests, 10 e2e tests)
  - [X] Frontend testing setup complete with example tests

---

### 8. Security Best Practices [ ]

- [ ] Sanitize user inputs (e.g. `class-validator`, middleware)
- [ ] Hash passwords with **bcrypt** (if managing auth manually)
- [ ] Use Helmet or similar middlewares to set HTTP headers
- [ ] Rate limit sensitive endpoints (auth, payments)
- [ ] Validate all incoming data (DTOs in NestJS)
- [ ] Keep `.env` secrets out of source control
- [ ] Restrict CORS to allowed origins

---

### 9. Performance & UX Optimization [ ]

- [ ] Optimize frontend bundle size (code splitting, lazy loading)
- [ ] Add loading states to all async operations
- [ ] Use `React.memo`, `useMemo`, `useCallback` where needed
- [ ] Enable cache headers for static assets (Vercel auto)
- [ ] Optional: Use `next/image` for optimized images

---

### 10. CI/CD and Deployment Readiness [ ]

- [ ] Setup `.dockerignore`, `.env.example` files
- [ ] Dockerize backend with production-ready Dockerfile
- [ ] Create `docker-compose.yml` for local development
- [ ] Setup GitHub Actions or CI:
  - Lint, test, build on PRs
- [ ] Deploy backend to Railway, Fly.io, VPS or Render
- [ ] Setup reverse proxy or subdomain for API (e.g. `api.birdnest.shop`)
- [ ] Setup health check route
- [ ] Optional: Use UptimeRobot to monitor API uptime

---

### 11. Observability and Logging [ ]

- [ ] Add global error handler middleware (backend)
- [ ] Add structured logs (`logger.service.ts` or `pino`)
- [ ] Track user events (e.g. order success, payment failure)
- [ ] Optional: Integrate error monitoring (Sentry / Logtail / Datadog)

---

### 12. Documentation and Developer Experience [ ]

- [ ] Generate Swagger docs at `/api-docs`
- [ ] Write `README.md` inside `backend/`:
  - Setup instructions, run, envs, API overview
- [ ] Add comments and typing to all exposed APIs
- [ ] Document common error messages and responses
- [ ] Provide sample curl or Postman collection
- [ ] Optional: Add API versioning (e.g. `/api/v1/`)
